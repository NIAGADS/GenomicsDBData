#!/bin/bash

set -e # exit on error

SO_EXTDBS_RLS='Sequence Ontology|2016-09-15'

FILE_PATH=/mnt/data/GenomicsDB/ADSP/annotation
NAME="ADSP Annotation WG File"
VERSION="2.1/2016_0114"
DESCRIPTION="This reference dataset includes annotations for the WES Release 3 Dataset, WGS V1 Dataset, and WES Release 3 Small Indels."

VEP_NAME="ADSP Annotation WG File: Ensembl VEP"
VEP_DESCRIPTION="predicted consequence and associated information for all revelant Ensembl transcript models"
VEP_VERSION=80

TOP_VEP_DESCRIPTION="most damaging VEP predicted consequence for each associated gene, computed across all transcripts, all non-NMD transcripts, and all protein coding transcripts"
TOP_VEP_VERSION=80-most-severe

SNP_EFF_NAME="ADSP Annotation WG File: SnpEff LOF"
SNP_EFF_VERSION=4.2
SNP_EFF_DESCRIPTION="loss of function annotations from SnpEff, provided by Xuequi Jian"

CADD_NAME="ADSP Annotation WG File: CADD"
CADD_VERSION=1.2
CADD_DESCRIPTION="Combined Annotation Dependent Depletion (CADD) raw and phred-normalized scores"

EXAC_NAME="ADSP Annotation WG File: ExAC"
EXAC_DESCRIPTION="Exome Aggregation Consortium (ExAC) allele frequencies and related annotations from unrelated individuals sequenced as part of various disease-specific and population genetic studies."
EXAC_VERSION=0.3

KAVIAR_NAME="ADSP Annotation WG File: Kaviar"
KAVIAR_DESCRIPTION="The Kaviar Genomic Variant Database is a compilation of SNVs, indels, and complex variants observed in humans"
KAVIAR_VERSION="150810-Public"

SPIDEX_NAME="ADSP Annotation WG File: SPIDEX"
SPIDEX_DESCRIPTION="a comprehensive set of genetic variants and their predicted effects on human splicing across the entire genome"
SPIDEX_VERSION="public version 1.0"
SPIDEX_DOWNLOAD_URL=http://www.deepgenomics.com/spidex-noncommercial-download

SWGR_NAME="ADSP Annotation WG File: SWGR"
SWGR_DESCRIPTION="The Scripps Wellderly Genome Resource compiled genome sequencing data from a cohort of individuals who are >80 years old with no chronic diseases to understand the genetics of disease-free aging without medical intervention"
SWGR_VERSION="1.0"
SWGR_DOWNLOAD_URL=http://www.stsiweb.org/wellderly/

CATO_NAME="ADSP Annotation WG File: CATO"
CATO_DESCRIPTION="contextual analysis of transcription factor occupancy (CATO) scores precomputed for dbSNP 142 in humans (hg19)"
CATO_VERSION="1.1"
CATO_DOWNLOAD_URL="http://www.uwencode.org/proj/Maurano_et_al_func_var/"

DATASET=false
LOAD_EXTERNAL_DATABASE=false
LOAD_DATA=false
PATCH=false
COMMIT=""
PREPROCESS=false
LOAD_TABLES=false

while [[ $# -gt 0 ]]
do

    key="$1"

    case $key in
	--dataset)
	    DATASET="$2"
	    shift
	    ;;
	--loadXdbr)
	    LOAD_EXTERNAL_DATABASE=true
	    ;;
	--loadSupportingTables)
	    LOAD_TABLES=true
	    ;;
	--preprocess)
	    PREPROCESS="--preprocess"
	    ;;
	--loadData)
	    LOAD_DATA=true
	    ;;
	--runPatches)
	    PATCH=true
	    ;;
	--commit)
	    COMMIT="--commit"
	    ;;
	*)
            # unknown option
	    ;;
    esac
    shift # past argument or value
done

if [ ${DATASET} = false ] && [ ${LOAD_EXTERNAL_DATABASE} = false ] ; then
    echo "Must set dataset to one of WES_R3, WGS_V1, WES_R3_INDELS using --dataset flag"
    exit
fi

# create external database and external database release entries
if [ ${LOAD_EXTERNAL_DATABASE} = true ] ; then
    echo "XDBRS for ADSP WG Annotation"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${NAME}\" --databaseVersion \"${VERSION}\" --description \"${DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${NAME}" --databaseVersion "${VERSION}" --description "${DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for VEP"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${VEP_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${VEP_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${VEP_NAME}\" --databaseVersion \"${VEP_VERSION}\" --description \"${VEP_DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${VEP_NAME}" --databaseVersion "${VEP_VERSION}" --description "${VEP_DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for VEP -- most severe"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${VEP_NAME}\" --databaseVersion \"${TOP_VEP_VERSION}\" --description \"${TOP_VEP_DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${VEP_NAME}" --databaseVersion "${TOP_VEP_VERSION}" --description "${TOP_VEP_DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for SnpEff"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${SNP_EFF_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${SNP_EFF_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${SNP_EFF_NAME}\" --databaseVersion \"${SNP_EFF_VERSION}\" --description \"${SNP_EFF_DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${SNP_EFF_NAME}" --databaseVersion "${SNP_EFF_VERSION}" --description "${SNP_EFF_DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for ExAC"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${EXAC_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${EXAC_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${EXAC_NAME}\" --databaseVersion \"${EXAC_VERSION}\" --description \"${EXAC_DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${EXAC_NAME}" --databaseVersion "${EXAC_VERSION}" --description "${EXAC_DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}


    echo "XDBRS for CADD"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${CADD_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${CADD_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${CADD_NAME}\" --databaseVersion \"${CADD_VERSION}\" --description \"${CADD_DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${CADD_NAME}" --databaseVersion "${CADD_VERSION}" --description "${CADD_DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for Kaviar"
    COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${KAVIAR_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${KAVIAR_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${KAVIAR_NAME}\" --databaseVersion \"${KAVIAR_VERSION}\" --description \"${KAVIAR_DESCRIPTION}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${KAVIAR_NAME}" --databaseVersion "${KAVIAR_VERSION}" --description "${KAVIAR_DESCRIPTION}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for SPIDEX"
   COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${SPIDEX_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${SPIDEX_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${SPIDEX_NAME}\" --databaseVersion \"${SPIDEX_VERSION}\" --description \"${SPIDEX_DESCRIPTION}\" --downloadUrl \"${SPIDEX_DOWNLOAD_URL}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${SPIDEX_NAME}" --databaseVersion "${SPIDEX_VERSION}" --description "${SPIDEX_DESCRIPTION}" --downloadUrl "${SPIDEX_DOWNLOAD_URL}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for CATO"

  COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${CATO_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${CATO_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${CATO_NAME}\" --databaseVersion \"${CATO_VERSION}\" --description \"${CATO_DESCRIPTION}\" --downloadUrl \"${CATO_DOWNLOAD_URL}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${CATO_NAME}" --databaseVersion "${CATO_VERSION}" --description "${CATO_DESCRIPTION}" --downloadUrl "${CATO_DOWNLOAD_URL}" --comment "${COMMENT}" ${COMMIT}

    echo "XDBRS for SWGR"
  COMMENT="GUS::Supported::Plugin::InsertExternalDatabase --name \"${SWGR_NAME}\""
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${SWGR_NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${SWGR_NAME}\" --databaseVersion \"${SWGR_VERSION}\" --description \"${SWGR_DESCRIPTION}\" --downloadUrl \"${SWGR_DOWNLOAD_URL}\""
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${SWGR_NAME}" --databaseVersion "${SWGR_VERSION}" --description "${SWGR_DESCRIPTION}" --downloadUrl "${SWGR_DOWNLOAD_URL}" --comment "${COMMENT}" ${COMMIT}
    
fi

if [ ${LOAD_TABLES} = true ] ; then
    echo "Loading supporting tables"
    tab2gusXml -i ${PROJECT_HOME}/NiagadsData/Load/data/annotation_types.txt --table "NIAGADS::AnnotationType" > ${FILE_PATH}/annotation_types.xml
    COMMENT="GUS::Supported::Plugin::LoadGusXml --file ${FILE_PATH}/annotation_types.xml"
    ga GUS::Supported::Plugin::LoadGusXml --file ${FILE_PATH}/annotation_types.xml --comment "${COMMENT}" ${COMMIT}
fi
# run loading plugin

if [ ${LOAD_DATA} = true ] ; then
    echo "Processing ${DATASET}"
    FILE_SUFFIX="_vep80_everything_updated_impacts.txt"

    DATASET_NAME="WGS Version 1 SNVs"
    if [ ${DATASET} = WES_R3 ] ; then
	DATASET_NAME="WES Release 3 SNVs"
    fi
    if [ ${DATASET} = WES_R3_INDELS ] ; then
	DATASET_NAME="WES Release 3 small INDELs"
    fi

    FILE_PREFIX="WGS_v1"

    if [ ${DATASET} = WES_R3 ] ; then
	FILE_PREFIX="WES_release3_no_WGS"
	if [ ${PREPROCESS} = "--preprocess" ] ; then
	    extractUniqueAdspWesVariants --dir ${FILE_PATH} --wes WES_release3${FILE_SUFFIX}.gz --wgs WGS_v1${FILE_SUFFIX}.gz --output ${FILE_PATH}/${FILE_PREFIX}${FILE_SUFFIX}
	    gzip ${FILE_PATH}/${FILE_PREFIX}${FILE_SUFFIX}
	fi
    fi
    if [ ${DATASET} = WES_R3_INDELS ] ; then
	FILE_PREFIX="WES_small_indels"
    fi

    LOG_FILE_PREFIX="preprocess"
    if [ ${PREPROCESS} = false ] ; then
	LOG_FILE_PREFIX="load"
    fi

    echo "${LOG_FILE_PREFIX}"

    COMMENT="ga NiagadsData::Load::Plugin::LoadAdspVepResult --file ${FILE_PATH}/original_files/${FILE_PREFIX}${FILE_SUFFIX}.gz  --extDbRlsSpec \"${NAME}|${VERSION}\" --vepExtDbRlsSpec \"${VEP_NAME}|${VEP_VERSION}\"  --name \"ADSP Annotation Working Group Ensembl Variant Effect Prediction (VEP) for ${DATASET_NAME}\" --description 'Ensembl VEP80 Predicted consequence and associated information for all relevant Ensembl transcript models' --sourceId ADSP_${DATASET}_VEP --preprocessDir ${FILE_PATH}/preprocess --dataset ${DATASET} ${PREPROCESS} --ignoreMergedSnps"

    echo "Running ${COMMENT} ${COMMIT}"
    echo ""
    ga NiagadsData::Load::Plugin::LoadAdspVepResult --file ${FILE_PATH}/original_files/${FILE_PREFIX}${FILE_SUFFIX}.gz --extDbRlsSpec "${NAME}|${VERSION}" --vepExtDbRlsSpec "${VEP_NAME}|${VEP_VERSION}"  --name "ADSP Annotation Working Group Ensembl Variant Effect Prediction (VEP) for ${DATASET_NAME}" --description 'Ensembl VEP80 Predicted consequence and associated information for all relevant Ensembl transcript models' --sourceId ADSP_${DATASET}_VEP --preprocessDir ${FILE_PATH}/preprocess --dataset ${DATASET} ${PREPROCESS} --ignoreMergedSnps --comment "${COMMENT}"  ${COMMIT} > ${LOG_FILE_PREFIX}_${DATASET}_vep.log 2>&1
# --skipUpdateExistingVariants 
fi


# patches
if [ ${PATCH} = true ] ; then

    # patch rankings
    echo "PATCH ADSP Consequence Impact Rankings"
    echo "produces _updated_impact.txt.gz files"
    patchAdspVepEverythingEffectRanks -a ${FILE_PATH}/WGS_v1_vep80_everything.txt.gz -r ensembl_ranking_table.csv
    patchAdspVepEverythingEffectRanks -a ${FILE_PATH}/WES_release3_vep80_everything.txt.gz -r ensembl_ranking_table.cs
    patchAdspVepEverythingEffectRanks -a ${FILE_PATH}/WES_small_indels_vep80_everything.txt.gz -r ensembl_ranking_table.csv
  
fi
