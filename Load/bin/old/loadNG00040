#!/bin/bash

set -e # exit on error

FILE_PATH=/mnt/data/GenomicsDB/niagads_resources/
ACCESSION=NG00040

FILE=SuppTableS1_MDS_Summary.txt
ANNOTATION_FILE=array_annotation/UNGCexon10K_15035704_A.csv

DISEASE=("AD" "FTD" "PSP")
DISEASE_LONG=("Alzheimer's disease" "frontotemporal dementia" "progressive supranuclear palsy")
PAN_NAME="Multi-ethnic exome array: "
PAN_DESCRIPTION="a multi-ethnic exome array study to identify low-frequency coding variants that affect susceptibility to "

N_DATASETS=3
EXT_DBS_RLS="NIAGADS Datasets|current"

LOAD_DATA=false
GENERATE_LOAD_FILES=false
LOAD_STUDY=false
PATCH=false
COMMIT=""
PREPROCESS=""


while [[ $# -gt 0 ]]
do

    key="$1"

    case $key in
	--loadStudy)
	    LOAD_STUDY=true
	    PROTOCOL_APP_NODE_ID="$2"
	    shift
	    ;;
	--loadData)
	    LOAD_DATA=true
	    ;;
	--runPatches)
	    PATCH=true
	    ;;
	--preprocess)
	    PREPROCESS="--preprocess"
	    ;;
	--generateLoadFiles)
	    GENERATE_LOAD_FILES=true
	    ;;
	--commit)
	    COMMIT="--commit"
	    ;;
	*)
            # unknown option
	    ;;
    esac
    shift # past argument or value
done

# run loading plugin
if [ ${GENERATE_LOAD_FILES} = true ] ; then 

    for i in "${!DISEASE[@]}" ; 
    do 
	echo "Generating Load File for ${DISEASE[$i]}"
	generateNG00040LoadFile --dir ${FILE_PATH}${ACCESSION} -a ${ANNOTATION_FILE} -f ${FILE} --disease ${DISEASE[$i]} 
    done
fi


if [ ${LOAD_DATA} = true ] ; then 
   
    for i in "${!DISEASE[@]}" ; 
    do
	echo "Loading ${ACCESSION}_${DISEASE[$i]} -- positional variants"
	COMMENT="GenomicsDBData::Load::Plugin::LoadSeqVariationResult --file ${FILE_PATH}/results_seqvariation_gwas_${ACCESSION}_${DISEASE[$i]}.csv --extDbRlsSpec \"${EXT_DBS_RLS}\" --name \"${PAN_NAME}${DISEASE[$i]}\" --description \"${PAN_DESCRIPTION}${DISEASE_LONG[$i]} (${DISEASE[$i]})\" --sourceId ${ACCESSION}_${DISEASE[$i]}  --subtypeSourceRef STATO_0000091 --variantSource NIAGADS --studySourceId ${ACCESSION} --checkAltVariantIds --ignoreMergedSnps"
	echo "${COMMENT}"
	ga GenomicsDBData::Load::Plugin::LoadSeqVariationResult --file ${FILE_PATH}${ACCESSION}/gwas_summary_statistics_${ACCESSION}_${DISEASE[$i]}.csv --extDbRlsSpec "${EXT_DBS_RLS}" --name "${PAN_NAME}${DISEASE[$i]}" --description "${PAN_DESCRIPTION}${DISEASE_LONG[$i]} (${DISEASE[$i]})" --sourceId ${ACCESSION}_${DISEASE[$i]} --variantSource NIAGADS --subtypeSourceRef STATO_0000091 --checkAltVariantIds  --ignoreMergedSnps --studySourceId ${ACCESSION} --comment "${COMMENT}"  ${COMMIT} > load_seqvariationresult_${ACCESSION}_${DISEASE[$i]}.log 2>&1 

	echo "Loading ${ACCESSION}_${DISEASE[$i]} - refSNPs"
	COMMENT="GenomicsDBData::Load::Plugin::LoadSeqVariationResult --file ${FILE_PATH}/results_seqvariation_gwas_${ACCESSION}_${DISEASE[$i]}_rs.csv --extDbRlsSpec \"${EXT_DBS_RLS}\" --name \"${PAN_NAME}${DISEASE[$i]}\" --description \"${PAN_DESCRIPTION}${DISEASE_LONG[$i]} (${DISEASE[$i]})\" --sourceId ${ACCESSION}_${DISEASE[$i]}  --subtypeSourceRef STATO_0000091 --variantSource NIAGADS --useRefSnpId --skipMissingVariants --ignoreMergedSnps"
	echo "${COMMENT}"
	ga GenomicsDBData::Load::Plugin::LoadSeqVariationResult --file ${FILE_PATH}${ACCESSION}/gwas_summary_statistics_${ACCESSION}_${DISEASE[$i]}_rs.csv --extDbRlsSpec "${EXT_DBS_RLS}" --name "${PAN_NAME}${DISEASE[$i]}" --description "${PAN_DESCRIPTION}${DISEASE_LONG[$i]} (${DISEASE[$i]})" --sourceId ${ACCESSION}_${DISEASE[$i]} --variantSource NIAGADS --subtypeSourceRef STATO_0000091  --useRefSnpId --skipMissingVariants --ignoreMergedSnps --comment "${COMMENT}"  ${COMMIT} > load_seqvariationresult_${ACCESSION}_${DISEASE[$i]}_rs.log 2>&1 
    done
fi


# patches
if [ ${PATCH} = true ] ; then
    echo "no patches"
    # runSqlPatch --file ?
fi
