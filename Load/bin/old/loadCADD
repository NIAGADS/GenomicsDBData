#!/bin/bash

set -e # exit on error

FILE_PATH=/mnt/data/GenomicsDB/ADSP/annotation/external_resources/CADD
ACCESSION=CADD

PREPROCESS_FILE_PATH=${FILE_PATH}/preprocess

NAME="CADD: Combined Annotation Dependent Depletion"
DESCRIPTION="CADD is a tool for scoring the deleteriousness of single nucleotide variants as well as insertion/deletions variants in the human genome."
VERSION=1.2
DOWNLOAD_URL=https://cadd.gs.washington.edu/download
ID_URL=https://cadd.gs.washington.edu/

# CHROMOSOMES=`seq 1 22`;
CHROMOSOMES=`seq 3 22`;
CHROMOSOMES+=" X Y M";

LOAD_EXTERNAL_DATABASE=false
LOAD_DATA=false
PATCH=false
COMMIT=""
PREPROCESS=false
EXTRACT=false
LOAD_TABLES=false
CHR=all


while [[ $# -gt 0 ]]
do

    key="$1"

    case $key in
	--loadXdbr)
	    LOAD_EXTERNAL_DATABASE=true
	    ;;
	--loadSupportingTables)
	    LOAD_TABLES=true
	    ;;
	--generateLoadFiles)
	    PREPROCESS=true
	    CHR="$2"
	    shift
	    ;;
	--loadData)
	    LOAD_DATA=true
	    CHR="$2"
	    shift
	    ;;
	--runPatches)
	    PATCH=true
	    ;;
	--commit)
	    COMMIT="--commit"
	    ;;
	*)
            # unknown option
	    ;;
    esac
    shift # past argument or value
done


# create external database and external database release entries
if [ ${LOAD_EXTERNAL_DATABASE} = true ] ; then
    COMMENT="ga GUS::Supported::Plugin::InsertExternalDatabase --name \"${NAME}\"" 
    ga GUS::Supported::Plugin::InsertExternalDatabase --name "${NAME}" --comment "${COMMENT}" ${COMMIT}

    COMMENT="ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName \"${NAME}\" --databaseVersion \"${VERSION}\" --description \"${DESCRIPTION}\" --downloadUrl \"${DOWNLOAD_URL}\" --idUrl \"${ID_URL}\"" 
    ga GUS::Supported::Plugin::InsertExternalDatabaseRls --databaseName "${NAME}" --databaseVersion "${VERSION}" --description "${DESCRIPTION}"  --downloadUrl "${DOWNLOAD_URL}" --idUrl "${ID_URL}" --comment "${COMMENT}" ${COMMIT}
fi



if [ ${PREPROCESS} = true ] ; then
    echo "Target Chromosome: ${CHR}"
    for c in ${CHROMOSOMES}
    do
	if [ ${c} = ${CHR} ] || [ ${CHR} = "all" ] ; then
	    echo "Generating Load File for chr${c}"
	    CMD="generateCaddSnvLoadFile --d ${FILE_PATH} -p ${PREPROCESS_FILE_PATH} --chr ${c}"
	    echo ${CMD}
	    generateCaddSnvLoadFile --d ${FILE_PATH} -p ${PREPROCESS_FILE_PATH} --chr ${c}
	fi
    done
fi

if [ ${LOAD_DATA} = true ] ; then
    echo "Target Chromosome: ${CHR}"
    EXTDBRLS="${NAME}|${VERSION}"
    for c in ${CHROMOSOMES}
    do
	if [ ${c} = ${CHR} ] || [ ${CHR} = "all" ] ; then
	    echo "Loading CADD for chr${c}"
	    COMMENT="CHR: ${c} - ga GenomicsDBData::Load::Plugin::LoadSeqVariationResult --file ${PREPROCESS_FILE_PATH}/results_seqvariation_CADD_${c}.csv --extDbRlsSpec \"${EXTDBRLS}\" --name \"CADD v1.2\" --description \"CADDv1.2 raw and phred-normalized scores\" --sourceId ${ACCESSION}  --subtypeSourceRef operation_3226 --variantSource CADD --useNaFeatureId"
	    echo "Running ${COMMENT}"
	    ga GenomicsDBData::Load::Plugin::LoadSeqVariationResult --file ${PREPROCESS_FILE_PATH}/results_seqvariation_CADD_${c}.csv --extDbRlsSpec "${EXTDBRLS}" --name "CADD v1.2" --description "CADDv1.2 raw and phred-normalized scores" --sourceId ${ACCESSION}  --subtypeSourceRef operation_3226 --useNaFeatureId  --variantSource CADD  --comment "${COMMENT}" ${COMMIT} > load_seqvariationresult_cadd_chr${c}.log 2>&1
	fi
    done
fi
